# Автоматическое тестирование

## Важно

Помните, что запуск тестов через CI стоит денег. 

Пожалуйста, не отлаживайтесь через CI, не отправляйте решения, которые не проходят тесты локально.

## Шаги, которые нужно выполнить 1 раз

### Регистрация

#### Шаг 1

Заведите аккаунт на https://gitlab.com/, если у вас его нет. Избегайте сложных имен с точками внутри.

#### Шаг 2

Зарегистрируйтесь в [приложении](http://tpcc.btty.su:5111):

Поля формы для регистрации:
- `Gitlab Username` – ваш логин на гитлабе, например, `Lipovsky`. Логин – _case-sensitive_!
- `First Name` – ваше имя латиницей
- `Last Name` – ваша фамилия латиницей
- `Group` – номер вашей группы 
- `Secret Code` – `tpcc-course`

После заполнения формы жмите `Register`. Ждите.

#### Шаг 3

Вы попали в приложение, осмотритесь.

В верхней панели вы увидите ссылки на:
- Созданный для вас приватный репозиторий для решений
- Страницу сабмитов

В любой непонятной ситуации с приложением поможет одно из двух:
* `/signup` -> Заполняете поля формы -> Жмете `Register`
* `/` -> Жмете `Login`

### Аттач репозитория с решениями

Во время регистрации был создан репозиторий для ваших решений. 

В этот репозиторий вы будете коммитить и пушить решения (только не голыми руками, а через консольный клиент), там же будут запускаться автоматические тесты.

#### Шаг 1

Перейдите в локальную копию репозитория курса:
```shell
cd /tpcc/tpcc-course-2020
```

#### Шаг 2

Прицепите к репозиторию курса репозиторий с решениями:
```shell
tpcc attach {solutions-repo-url}
```
В `{solutions-repo-url}` подставьте урл созданного при регистрации репозитория.

Команда будет выглядеть примерно так:
```shell
tpcc attach https://gitlab.com/tpcc-course/777-roman-lipovsky-u-lipovsky
```

Можно аттачить иначе: 
```shell
tpcc attach git@gitlab.com:tpcc-course/777-roman-lipovsky-u-lipovsky
```
Тогда вам не придется вводить логин и пароль для каждого пуша.

Команду `attach` можно выполнить повторно: в этом случае предыдущая локальная копия сотрется (с вашего явного разрешения), но это не страшно, если вы запушили все ваши коммиты с помощью `tpcc push`.

#### Шаг 3

Выполните команду
```shell
tpcc show-config
```

Вы увидите поля конфига, который нужно заполнить для сдачи задач.
Часть полей будет заполнена автоматически (например, `gitlab.user`, `name.first`, `name.last`). Но все же убедитесь, что они заполнены корректно.

#### Шаг 4

Получите токен для работы с API https://gitlab.com/

Для этого на https://gitlab.com/ зайдите в `Settings` своего профиля, затем в `Access Tokens`, выберите произвольное имя для вашего токена, поставьте галку напротив `api` и нажмите `Create personal access token`. 

См. [Personal Access Tokens](https://docs.gitlab.com/ee/user/profile/personal_access_tokens.html)

Токен – это полученная случайная строчка из цифр и букв. Имя токена дальше нам не понадобится.
Сохраните полученный токен, иначе он пропадет! 

Токен будет нужен для создания merge request-ов из консольного клиента.

#### Шаг 5

Установите токен для консольного клиента:
```shell
tpcc config gitlab.token {gitlab-token}
```

Здесь `{gitlab-token}` – токен, полученный вами на предыдущем шаге.

#### Шаг 6

В поле `assignee` конфига клиента укажите логин на gitlab вашего семинариста:
```shell
tpcc config assignee Lipovsky
```

[Логины преподавателей](docs/staff.md)

## Работа с задачей / репозиторием решений

#### Шаг 1

Идем в директорию с задачей:
```shell
cd tasks/0-intro/deadlock
```

#### Шаг 2

Коммитим текущий код задачи в отдельную ветку локального репозитория решений:
```shell
tpcc commit
```

Можно указать комментарий к коммиту:
```shell
tpcc commit -m 'my solution'
```

#### Шаг 3

Пушим локальные коммиты в ветку удаленного репозитория с вашими решениями:
```shell
tpcc push
```

#### Шаг 4

Создаем Merge Request, на котором будет запускаться CI:
```shell
tpcc merge
```

Команду `merge` нужно выполнить всего лишь один раз для каждой задачи.

После ее выполнения вы получите ссылку на созданный MR.

#### Дальнейшие шаги

Пусть дальше вы нашли и исправили баги в своем коде:

```
// ...
tpcc commit -m 'fix bug'
// ...
tpcc commit -m 'fix data race'
tpcc push
```

После `push` новые коммиты попадут в уже существующий MR и перезапустят CI.

## Посылки

Вы можете посмотреть все свои посылки во вкладке `Submits` в приложении или в разделе `Merge requests` вашего репозитория с решениями на гитлабе.

Нажав на плашку в колонке `status` вы сможете посмотреть подробный отчет о тестировании.