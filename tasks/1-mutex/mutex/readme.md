# Мьютекс

В этой задаче вы должны реализовать [std::mutex](https://ru.cppreference.com/w/cpp/thread/mutex). 

Отличие мьютекса от спинлока в том, что мьютекс _блокирует_ поток, который ожидает захвата блокировки.

Требования:

* Захват и освобождение мьютекса, на владение которым больше никто не претендует, должен происходить максимально быстро, без переключения в ядро операционной системы..

* Если поток не может захватить блокировку, потому что его опережают другие потоки (такую ситуацию называют _contention_), то он должен _заблокироваться_ до освобождения мьютекса и освободить процессор.

Реализовать блокировку потока операционной системы целиком в пространстве пользователя невозможно, за исполнение потока отвечает планировщик операционной системы.

Для реализации блокировок в пространстве пользователя Linux предоставляет примитив **futex** – ядерная очередь спящих потоков, которая привязана к ячейке памяти в адресном пространстве пользователя. Пользователь работает с фьютексом через соответствующий системный вызов – [futex](http://man7.org/linux/man-pages/man2/futex.2.html). 

Любой системный вызов – это накладные расходы на переключение в ядро и обратно, так что ваша реализация должна свести их к минимуму.

## Фьютекс

[Basics of Futexes](https://eli.thegreenplace.net/2018/basics-of-futexes/)

Упрощенное API:

- `FutexWait(addr, value)` – сравнивает значение по адресу `addr` со значением `value`, и если эти значения совпадают, то паркует текущий поток в очереди фьютекса, связанной с адресом `addr`. В противном случае возвращает управление. Чтение, сравнение и парковка происходят атомарно относительно других вызвов `FutexWait` и `FutexWake`.

- `FutexWake(addr, count)` – будит `count` потоков, спящих в вызове `FutexWait`.

Функции работают с 32-битными словами!

---

В этой задаче мы будем работать с фьютексами с помощью вспомогательного класса `Futex`:

```cpp
atomic<uint32_t> state; 
Futex futex{state};

// будим <= 3 потока, спящих в Wait
futex.Wake(3);

// засыпаем, если значение атомика state равно 1 
futex.Wait(/*expected=*/1);
```

---

В С++20 появилось API для фьютекса:

https://en.cppreference.com/w/cpp/atomic/atomic/wait

---

Шаблон решения находится в файле `mutex.hpp`.

